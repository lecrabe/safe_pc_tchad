names(legend) <- c("item","value","class")
legend$class <- gsub("label=","",x = legend$class)
legend$class <- gsub("/","",x = legend$class)
legend$class <- gsub(">","",x = legend$class)
legend$value <- gsub("value=","",x = legend$value)
legend$value <- gsub("\"","",x = legend$value)
legend <- legend[,2:3]
nbclass <- nrow(legend)
legend$value <- as.numeric(legend$value)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
procimgdir
v1 <- c(658521.8,899480.1,658542.7,899474.7)
v2 <- c(654867.1,905720.3,654881.9,905723.6)
v3 <- c(661263.7,911848.8,661284.9,911836.9)
v4 <- c(663856.0,905913.1,663873.0,905909.3)
v5 <- c(665309.9,900033.7,665338.4,900027.4)
v6 <- c(664139.8,898281.1,664164.5,898272.5)
v7 <- c(658826.6,904147.7,658841.1,904147.7)
v8 <- c(659942.9,905677.8,659962.8,905677.8)
v9<- c(660770.8,905418.4,660789.1,905421.8)
v10 <- c(660550.4,904111.8,660566.8,904113.7)
v11 <- c(660267.5,903875.4,660290.4,903878.9)
v12 <- c(660614.8,904031.2,660635.4,904029.3)
all_v <- rbind(v1,v2,v3,v4,v5,v6,v7,v8,v9,v10)
shift_x <- all_v[,1]-all_v[,3]
shift_y <- all_v[,2]-all_v[,4]
plot(shift_x,shift_y)
dev.off()
par(mfrow = c(5,4))
par(mar=c(0,0,0,0))
for(i in 1:10){
v <- all_v[i,]
lp <- list()
e<-extent((v[1]+v[3])/2-50,
(v[1]+v[3])/2+50,
(v[2]+v[4])/2-50,
(v[2]+v[4])/2+50)
poly <- Polygons(list(Polygon(cbind(
c(e@xmin,e@xmin,e@xmax,e@xmax,e@xmin),
c(e@ymin,e@ymax,e@ymax,e@ymin,e@ymin))
)),"box")
lp <- append(lp,list(poly))
## Transform the list into a SPDF PRIMER ERROR
box <-SpatialPolygonsDataFrame(
SpatialPolygons(lp,1:length(lp)),
data.frame("box"),
match.ID = F
)
rasname <- paste0(procimgdir,"aoi1_2004_west_utm.tif")
nir <- crop(raster(rasname,4),box)
grn <- crop(raster(rasname,2),box)
red <- crop(raster(rasname,1),box)
stack <- stack(nir,red,grn)
plot(box)
plotRGB(stack,stretch="hist",add=T)
points(v[1],v[2],col="yellow")
points(v[3],v[4],col="green")
rasname <- paste0(procimgdir,"aoi1_2016_spot.TIF")
nir <- crop(raster(rasname,4),box)
grn <- crop(raster(rasname,2),box)
red <- crop(raster(rasname,1),box)
stack <- stack(nir,red,grn)
plot(box)
plotRGB(stack,stretch="hist",add=T)
points(v[1],v[2],col="yellow")
points(v[3],v[4],col="green")
}
system(sprintf("(echo %s;echo %s;echo %s;echo %s;echo %s;echo %s;echo %s;echo %s;echo %s;echo %s) | gdaltransform -i %s > %s",
paste(v1[1],v1[2],sep=" "),
paste(v2[1],v2[2],sep=" "),
paste(v3[1],v3[2],sep=" "),
paste(v4[1],v4[2],sep=" "),
paste(v5[1],v5[2],sep=" "),
paste(v6[1],v6[2],sep=" "),
paste(v7[1],v7[2],sep=" "),
paste(v8[1],v8[2],sep=" "),
paste(v9[1],v9[2],sep=" "),
paste(v10[1],v10[2],sep=" "),
paste0(procimgdir,"aoi1_2004_west_utm.tif"),
paste0(procimgdir,"coord_west_to_spot.txt")
))
local <- read.table(paste0(procimgdir,"coord_west_to_spot.txt"))
system(sprintf("gdal_translate -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s   %s %s",
local[1,1],local[1,2],v1[3],v1[4],
local[2,1],local[2,2],v2[3],v2[4],
local[3,1],local[3,2],v3[3],v3[4],
local[4,1],local[4,2],v4[3],v4[4],
local[5,1],local[5,2],v5[3],v5[4],
local[6,1],local[6,2],v6[3],v6[4],
local[7,1],local[7,2],v7[3],v7[4],
local[8,1],local[8,2],v8[3],v8[4],
local[9,1],local[9,2],v9[3],v9[4],
local[10,1],local[10,2],v10[3],v10[4],
paste0(procimgdir,"aoi1_2004_west_utm.tif"),
paste0(procimgdir,"tmp_aoi1_2004_west_utm_shift.tif")
))
system(sprintf("gdal_translate -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s -gcp %s %s %s %s   %s %s",
local[1,1],local[1,2],v1[3],v1[4],
local[2,1],local[2,2],v2[3],v2[4],
local[3,1],local[3,2],v3[3],v3[4],
local[4,1],local[4,2],v4[3],v4[4],
local[5,1],local[5,2],v5[3],v5[4],
local[6,1],local[6,2],v6[3],v6[4],
local[7,1],local[7,2],v7[3],v7[4],
local[8,1],local[8,2],v8[3],v8[4],
local[9,1],local[9,2],v9[3],v9[4],
local[10,1],local[10,2],v10[3],v10[4],
paste0(procimgdir,"aoi1_2004_west_utm.tif"),
paste0(procimgdir,"tmp_aoi1_2004_west_utm_shift.tif")
))
system(sprintf("gdalwarp -r bilinear -t_srs EPSG:32633 %s %s",
paste0(procimgdir,"tmp_aoi1_2004_west_utm_shift.tif"),
paste0(procimgdir,"aoi1_2004_west_utm_shift.tif")))
system(sprintf("gdalwarp -r bilinear -t_srs EPSG:32633 %s %s",
paste0(procimgdir,"tmp_aoi1_2004_west_utm_shift.tif"),
paste0(procimgdir,"aoi1_2004_west_utm_shift.tif")))
system(sprintf("gdal_translate -projwin 658069.905745 905973.274773 661849.521913 902760.601031 -co COMPRESS=LZW %s %s",
paste0(procimgdir,"aoi1_2004_west_utm_shift.tif"),
paste0(procimgdir,"/merge_aoi1_clip_2004.tif")
))
####################################################################################
####### Object:  Processing chain - MASTER script
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/08/22
####################################################################################
master_time <- Sys.time()
################################################################################
## Run the change detection
source(paste0(scriptdir,"change_detection_OTB.R"),echo=TRUE)
# ################################################################################
# ## Run the classification for time 1
outdir  <- paste0(tiledir,"/time1/")
dir.create(outdir)
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Run the classification for time 2
outdir  <- paste0(tiledir,"/time2/")
dir.create(outdir)
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Merge date 1 and date 2 (uncomment necessary script)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
################################################################################
## Call field data and inject into LCC map to generate statistics and biomass maps
# source(paste0(scriptdir,"inject_field_data.R"),echo=TRUE)
(overall_time <- (master_time - Sys.time()))
####################################################################################
####### Object:  Processing chain - MASTER script for parameters
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/09/01
####################################################################################
####### SET WHERE YOUR SCRIPTS ARE CLONED
clonedir  <- paste0("/media/dannunzio/OSDisk/Users/dannunzio/Documents/countries/tchad/scripts_tchad/")
####### SET WHERE YOUR IMAGE DIRECTORY IS
rawimgdir   <- "/media/dannunzio/hdd_remi/tchad/"
####### DATA WILL BE CREATED AND STORED HERE
rootdir    <- "/media/dannunzio/hdd_remi/tchad/"
#############################################################################
#############################################################################
#############################################################################
#############################################################################
####### Sub-directories
scriptdir  <- paste0(clonedir,"process/")
p_procdir  <- paste0(clonedir,"pre-processing/")
####################################################################################
#######          PACKAGES
####################################################################################
source(paste0(scriptdir,"load_packages.R"),echo=TRUE)
####################################################################################
#######          CHANGE ACCORDINGLY TO PERIOD OF INTEREST
####################################################################################
time1       <- "2004"
time2       <- "2016"
tile        <- "aoi1_clip"
####################################################################################
#######          SET PARAMETERS
####################################################################################
source(paste0(scriptdir,"set_parameters_master.R"),echo=TRUE)
source(paste0(scriptdir,"set_parameters_imad.R"),echo=TRUE)
################################################################################
## Parameters for classification for time 1
outdir   <- paste0(tiledir,"/time1/")
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t1_file_m   <-  output_rf   # time 1 file
segs_id     <- all_sg_id
################################################################################
## Parameters for classification for time 2
outdir  <- paste0(tiledir,"/time2/")
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t2_file_m   <-  output_rf  # time 2 file
################################################################################
## Parameters for merge
source(paste0(scriptdir,"set_parameters_merge.R"),echo=TRUE)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
system(sprintf("oft-his -i %s -o %s -um %s -maxval %s",
t2_file_m,
t2_cl_st,
segs_id,
nbclass
))
segs_id
t2_file_m
system(sprintf("oft-his -i %s -o %s -um %s -maxval %s",
t1_file_m,
t1_cl_st,
segs_id,
nbclass
))
####################################################################################
####### Object:  Processing chain - MASTER script for parameters
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/09/01
####################################################################################
####### SET WHERE YOUR SCRIPTS ARE CLONED
clonedir  <- paste0("/media/dannunzio/OSDisk/Users/dannunzio/Documents/countries/tchad/scripts_tchad/")
####### SET WHERE YOUR IMAGE DIRECTORY IS
rawimgdir   <- "/media/dannunzio/hdd_remi/tchad/"
####### DATA WILL BE CREATED AND STORED HERE
rootdir    <- "/media/dannunzio/hdd_remi/tchad/"
#############################################################################
#############################################################################
#############################################################################
#############################################################################
####### Sub-directories
scriptdir  <- paste0(clonedir,"process/")
p_procdir  <- paste0(clonedir,"pre-processing/")
####################################################################################
#######          PACKAGES
####################################################################################
source(paste0(scriptdir,"load_packages.R"),echo=TRUE)
####################################################################################
#######          CHANGE ACCORDINGLY TO PERIOD OF INTEREST
####################################################################################
time1       <- "2004"
time2       <- "2016"
tile        <- "aoi1_clip"
####################################################################################
#######          SET PARAMETERS
####################################################################################
source(paste0(scriptdir,"set_parameters_master.R"),echo=TRUE)
source(paste0(scriptdir,"set_parameters_imad.R"),echo=TRUE)
################################################################################
## Parameters for classification for time 1
outdir   <- paste0(tiledir,"/time1/")
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t1_file_m   <-  output_rf   # time 1 file
segs_id     <- all_sg_id
################################################################################
## Parameters for classification for time 2
outdir  <- paste0(tiledir,"/time2/")
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t2_file_m   <-  output_rf  # time 2 file
################################################################################
## Parameters for merge
source(paste0(scriptdir,"set_parameters_merge.R"),echo=TRUE)
####################################################################################
####### Object:  Processing chain - MASTER script
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/08/22
####################################################################################
master_time <- Sys.time()
################################################################################
## Run the change detection
source(paste0(scriptdir,"change_detection_OTB.R"),echo=TRUE)
# ################################################################################
# ## Run the classification for time 1
outdir  <- paste0(tiledir,"/time1/")
dir.create(outdir)
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Run the classification for time 2
outdir  <- paste0(tiledir,"/time2/")
dir.create(outdir)
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Merge date 1 and date 2 (uncomment necessary script)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
################################################################################
## Call field data and inject into LCC map to generate statistics and biomass maps
# source(paste0(scriptdir,"inject_field_data.R"),echo=TRUE)
(overall_time <- (master_time - Sys.time()))
outdir  <- paste0(tiledir,"/time2/")
dir.create(outdir)
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
####################################################################################
####### Object:  Processing chain - MASTER script for parameters
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/09/01
####################################################################################
####### SET WHERE YOUR SCRIPTS ARE CLONED
clonedir  <- paste0("/media/dannunzio/OSDisk/Users/dannunzio/Documents/countries/tchad/scripts_tchad/")
####### SET WHERE YOUR IMAGE DIRECTORY IS
rawimgdir   <- "/media/dannunzio/hdd_remi/tchad/"
####### DATA WILL BE CREATED AND STORED HERE
rootdir    <- "/media/dannunzio/hdd_remi/tchad/"
#############################################################################
#############################################################################
#############################################################################
#############################################################################
####### Sub-directories
scriptdir  <- paste0(clonedir,"process/")
p_procdir  <- paste0(clonedir,"pre-processing/")
####################################################################################
#######          PACKAGES
####################################################################################
source(paste0(scriptdir,"load_packages.R"),echo=TRUE)
####################################################################################
#######          CHANGE ACCORDINGLY TO PERIOD OF INTEREST
####################################################################################
time1       <- "2004"
time2       <- "2016"
tile        <- "aoi1_clip"
####################################################################################
#######          SET PARAMETERS
####################################################################################
source(paste0(scriptdir,"set_parameters_master.R"),echo=TRUE)
source(paste0(scriptdir,"set_parameters_imad.R"),echo=TRUE)
################################################################################
## Parameters for classification for time 1
outdir   <- paste0(tiledir,"/time1/")
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t1_file_m   <-  output_rf   # time 1 file
segs_id     <- all_sg_id
################################################################################
## Parameters for classification for time 2
outdir  <- paste0(tiledir,"/time2/")
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t2_file_m   <-  output_rf  # time 2 file
################################################################################
## Parameters for merge
source(paste0(scriptdir,"set_parameters_merge.R"),echo=TRUE)
####################################################################################
####### Object:  Processing chain - MASTER script
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/08/22
####################################################################################
master_time <- Sys.time()
################################################################################
## Run the change detection
source(paste0(scriptdir,"change_detection_OTB.R"),echo=TRUE)
# ################################################################################
# ## Run the classification for time 1
outdir  <- paste0(tiledir,"/time1/")
dir.create(outdir)
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Run the classification for time 2
outdir  <- paste0(tiledir,"/time2/")
dir.create(outdir)
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
################################################################################
## Merge date 1 and date 2 (uncomment necessary script)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
################################################################################
## Call field data and inject into LCC map to generate statistics and biomass maps
# source(paste0(scriptdir,"inject_field_data.R"),echo=TRUE)
(overall_time <- (master_time - Sys.time()))
system(sprintf("otbcli_MultivariateAlterationDetector -in1 %s -in2 %s -out %s",
t1_input_o,
t2_input,
imad
))
system(sprintf("oft-clip.pl %s %s %s",
t2_input,
t1_input,
t1_input_o))
system(sprintf("otbcli_MultivariateAlterationDetector -in1 %s -in2 %s -out %s",
t1_input_o,
t2_input,
imad
))
r1         <- brick(t1_input_o)
origin(r1) <- origin(raster(t2_input))
writeRaster(r1,t1_input_o,overwrite=T)
system(sprintf("oft-clip.pl %s %s %s",
t2_input,
t1_input,
paste0(imaddir,"tmp_input_1.tif")
))
r1         <- brick(paste0(imaddir,"tmp_input_1.tif"))
origin(r1) <- origin(raster(t2_input))
writeRaster(r1,t1_input_o,overwrite=T)
system(sprintf("otbcli_MultivariateAlterationDetector -in1 %s -in2 %s -out %s",
t1_input_o,
t2_input,
imad
))
################################################################################
## Create a no change mask
system(sprintf("gdal_calc.py -A %s  --A_band=4 -B %s  --B_band=1 --outfile=%s --calc=\"%s\"",
imad,
imad,
paste0(imaddir,"tmp_noch.tif"),
paste0("(A > -0.5)*(A < 0.5)*(B > -0.5)*(B < 0.5)")
))
system(sprintf("gdal_translate -ot byte -co COMPRESS=LZW %s %s",
paste0(imaddir,"tmp_noch.tif"),
noch_msk))
system(sprintf("rm %s",
paste0(imaddir,"*tmp*.*")
))
(imad_time <- Sys.time() - imad_start_time)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
####################################################################################
####### Object:  Processing chain - MASTER script for parameters
####### Author:  remi.dannunzio@fao.org
####### Update:  2017/09/01
####################################################################################
####### SET WHERE YOUR SCRIPTS ARE CLONED
clonedir  <- paste0("/media/dannunzio/OSDisk/Users/dannunzio/Documents/countries/tchad/scripts_tchad/")
####### SET WHERE YOUR IMAGE DIRECTORY IS
rawimgdir   <- "/media/dannunzio/hdd_remi/tchad/"
####### DATA WILL BE CREATED AND STORED HERE
rootdir    <- "/media/dannunzio/hdd_remi/tchad/"
#############################################################################
#############################################################################
#############################################################################
#############################################################################
####### Sub-directories
scriptdir  <- paste0(clonedir,"process/")
p_procdir  <- paste0(clonedir,"pre-processing/")
####################################################################################
#######          PACKAGES
####################################################################################
source(paste0(scriptdir,"load_packages.R"),echo=TRUE)
####################################################################################
#######          CHANGE ACCORDINGLY TO PERIOD OF INTEREST
####################################################################################
time1       <- "2004"
time2       <- "2016"
tile        <- "aoi1_clip"
####################################################################################
#######          SET PARAMETERS
####################################################################################
source(paste0(scriptdir,"set_parameters_master.R"),echo=TRUE)
source(paste0(scriptdir,"set_parameters_imad.R"),echo=TRUE)
################################################################################
## Parameters for classification for time 1
outdir   <- paste0(tiledir,"/time1/")
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t1_file_m   <-  output_rf   # time 1 file
segs_id     <- all_sg_id
################################################################################
## Parameters for classification for time 2
outdir  <- paste0(tiledir,"/time2/")
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
t2_file_m   <-  output_rf  # time 2 file
################################################################################
## Parameters for merge
source(paste0(scriptdir,"set_parameters_merge.R"),echo=TRUE)
master_time <- Sys.time()
source(paste0(scriptdir,"change_detection_OTB.R"),echo=TRUE)
outdir  <- paste0(tiledir,"/time1/")
dir.create(outdir)
im_input <- t1_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
outdir  <- paste0(tiledir,"/time2/")
dir.create(outdir)
im_input <- t2_input
source(paste0(scriptdir,"set_parameters_classif.R"),echo=TRUE)
source(paste0(scriptdir,"prepare_training_data.R"),echo=TRUE)
source(paste0(scriptdir,"supervised_classification.R"),echo=TRUE)
source(paste0(scriptdir,"merge_datasets.R"),echo=TRUE)
source(paste0(scriptdir,"close_holes_morphology.R"),echo=TRUE)
t1_input
clonedir  <- paste0("/media/dannunzio/OSDisk/Users/dannunzio/Documents/countries/tchad/scripts_tchad/")
rawimgdir   <- "/media/dannunzio/hdd_remi/tchad/"
rootdir    <- "/media/dannunzio/hdd_remi/tchad/"
scriptdir  <- paste0(clonedir,"process/")
p_procdir  <- paste0(clonedir,"pre-processing/")
source(paste0(scriptdir,"load_packages.R"),echo=TRUE)
time1       <- "2004"
time2       <- "2016"
tile        <- "aoi1_clip"
source(paste0(scriptdir,"set_parameters_master.R"),echo=TRUE)
source(paste0(scriptdir,"set_parameters_imad.R"),echo=TRUE)
im_input
t1_input
